<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="iris-workstation-selector">
  <template>
    <style>
      :host {
        display: block;
        --paper-item: {
          @apply(--layout-justified);
        }
        --paper-progress-active-color:var(--mydoc-brown-800);
        --paper-progress-transition-duration: 0.08s;
        --paper-progress-transition-timing-function: ease;
        --paper-progress-transition-transition-delay: 0s;
      }
      
      paper-progress {
        width: 100%;
      }
      
      #current-workstation {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        cursor: pointer;
        width: 100%;
      }
      
      .ws-in-use {
        color: #ccc;
        font-weight: normal;
      }
      
      paper-item {
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      #progress-wrapper {
        height: 8px;
      }
    </style>

    <paper-dialog id="selector-dialog" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <h2>Сменить рабочее место      </h2>
      <paper-dialog-scrollable>
        <div id="progress-wrapper">
          <paper-progress indeterminate hidden="{{!inProgress}}"></paper-progress>
        </div>
        <paper-listbox id='list' selected="{{selectedWS}}">
          <template is="dom-repeat" items="[[workstations]]">
            <paper-item><span>[[item.label]]</span> <span class="ws-in-use" hidden$="[[!item.in_use]]">(Используется)</span> </paper-item>
          </template>
        </paper-listbox>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Отмена</paper-button>
        <paper-button disabled$="{{!canSelect(selectedWS)}}" on-tap="confirmSeletion">Выбрать</paper-button>
      </div>
    </paper-dialog>

    <iris-currentuser id="user" is-logged="{{isLogged}}"></iris-currentuser>
    <div hidden$="[[!isLogged]]" id="current-workstation" on-tap="openSelectDialog">
      <content></content>
      [[label]]
    </div>
  </template>
  <script>
    'use strict'
    Polymer({
      is: 'iris-workstation-selector',
      properties: {
        workstationType: {
          type: String,
          value: 'control-panel'
        }
      },
      observers: ['_userLogin(isLogged)'],
      ready() {
        this.inProgress = false;
      },
      _userLogin(isLogged) {
        if (!isLogged) return;

        this.current_ws = this.$.user.getWorkstation(this.workstationType);
        this.available = _.values(this.$.user.getAvailableWorkstations());

        if (!this.current_ws) return;

        this.label = this.current_ws.label;
      },
      canSelect(selectedWS) {
        return selectedWS !== -1 && this.available[selectedWS].id !== this.current_ws.id;
      },
      openSelectDialog() {
        this.$.list.select(-1);
        this.set('workstations', _.map(this.available, ws => {
          let in_use = ws.id == this.current_ws.id;
          return {
            in_use: in_use,
            label: ws.label
          };
        }));
        this.$["selector-dialog"].open();
      },
      confirmSeletion() {
        let selected_workstation = this.available[this.selectedWS].id;

        this.set('inProgress', true);
        this.$.user.switchTo(selected_workstation).then(() => {
          this.set('inProgress', false);
          this.current_ws = this.$.user.getWorkstation(this.workstationType);
          this.label = this.current_ws ? this.current_ws.label : 'Ошибка';

          this.$["selector-dialog"].close();

          this.fire('workstation-change', {
            workstation: selected_workstation
          });
        });
      }
    });
  </script>
</dom-module>